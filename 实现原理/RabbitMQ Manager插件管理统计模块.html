<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>RabbitMQ Manager插件管理统计模块 | </title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.7">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    <link rel="next" href="../实现原理/脑裂丢数调研.html" />
    
    
    <link rel="prev" href="../实现原理/限流机制.html" />
    

        
    </head>
    <body>
        
        
    <div class="book"
        data-level="2.12"
        data-chapter-title="RabbitMQ Manager插件管理统计模块"
        data-filepath="实现原理/RabbitMQ Manager插件管理统计模块.md"
        data-basepath=".."
        data-revision="Fri Aug 16 2019 12:08:27 GMT+0800 (CST)"
        data-innerlanguage="">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        前言
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="install/index.html">
            
                
                    <a href="../install/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        安装部署
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="install/erlang.html">
            
                
                    <a href="../install/erlang.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        Erlang安装
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="install/sourceCode.html">
            
                
                    <a href="../install/sourceCode.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        源码安装
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="install/rpm.html">
            
                
                    <a href="../install/rpm.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.</b>
                        
                        rpm安装
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="install/cluster_install.html">
            
                
                    <a href="../install/cluster_install.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.4.</b>
                        
                        集群搭建
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="实现原理/index.html">
            
                
                    <a href="../实现原理/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        实现原理
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="实现原理/启动.html">
            
                
                    <a href="../实现原理/启动.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        启动过程
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="实现原理/连接和通道.html">
            
                
                    <a href="../实现原理/连接和通道.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                        连接和通道
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="实现原理/写入概要.html">
            
                
                    <a href="../实现原理/写入概要.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.3.</b>
                        
                        写入概要
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="实现原理/写入过程-索引持久化.html">
            
                
                    <a href="../实现原理/写入过程-索引持久化.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.4.</b>
                        
                        写入过程-索引持久化
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="实现原理/写入过程-索引在内存的数据结构.html">
            
                
                    <a href="../实现原理/写入过程-索引在内存的数据结构.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.5.</b>
                        
                        写入过程-索引在内存的数据结构
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="实现原理/消息消费.html">
            
                
                    <a href="../实现原理/消息消费.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.6.</b>
                        
                        消息消费
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.7" data-path="实现原理/确认机制.html">
            
                
                    <a href="../实现原理/确认机制.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.7.</b>
                        
                        确认机制
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.8" data-path="实现原理/事务.html">
            
                
                    <a href="../实现原理/事务.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.8.</b>
                        
                        事务
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.9" data-path="实现原理/队列速率.html">
            
                
                    <a href="../实现原理/队列速率.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.9.</b>
                        
                        队列速率
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.10" data-path="实现原理/RabbitMQ内存监控.html">
            
                
                    <a href="../实现原理/RabbitMQ内存监控.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.10.</b>
                        
                        RabbitMQ内存监控
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.11" data-path="实现原理/限流机制.html">
            
                
                    <a href="../实现原理/限流机制.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.11.</b>
                        
                        限流机制
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="2.12" data-path="实现原理/RabbitMQ Manager插件管理统计模块.html">
            
                
                    <a href="../实现原理/RabbitMQ Manager插件管理统计模块.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.12.</b>
                        
                        RabbitMQ Manager插件管理统计模块
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.13" data-path="实现原理/脑裂丢数调研.html">
            
                
                    <a href="../实现原理/脑裂丢数调研.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.13.</b>
                        
                        脑裂丢数调研
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" ></a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="rabbitmq-manager-&#x63D2;&#x4EF6;&#x7BA1;&#x7406;&#x7EDF;&#x8BA1;&#x6A21;&#x5757;">RabbitMQ Manager &#x63D2;&#x4EF6;&#x7BA1;&#x7406;&#x7EDF;&#x8BA1;&#x6A21;&#x5757;</h1>
<p>RabbitMQ Manager &#x63D2;&#x4EF6;&#x5728;&#x542F;&#x52A8;&#x7684;&#x65F6;&#x5019; ,&#x4F1A;&#x542F;&#x52A8;&#x4E00;&#x4E2A; rabbit_mgmt_db &#x8FDB;&#x7A0B;</p>
<p>&#x8FD9;&#x4E2A;&#x8FDB;&#x7A0B;&#x5728;&#x591A;&#x4E2A;&#x8282;&#x70B9;&#x4E2D;&#x53EA;&#x4F1A;&#x6709;&#x5728;&#x4E00;&#x4E2A;&#x8282;&#x70B9;&#x4E0A;&#x8FD0;&#x884C;.&#x6240;&#x6709;&#x8282;&#x70B9;&#x4E0A;&#x7684;&#x961F;&#x5217;&#x4FE1;&#x606F;,&#x8282;&#x70B9;&#x72B6;&#x6001;,&#x8FDE;&#x63A5;&#x4FE1;&#x606F;,&#x901A;&#x9053;&#x4FE1;&#x606F;&#x7B49;&#x90FD;&#x4E0A;&#x62A5;&#x5230;&#x8FD9;&#x4E2A;&#x8FDB;&#x7A0B;&#x91CC;&#x8FDB;&#x884C;&#x5B58;&#x50A8;.</p>
<p>HTTP overview ,queues,vhost &#x7B49;&#x63A5;&#x53E3;&#x90FD;&#x5411; &#x8FD9;&#x4E2A;&#x8FDB;&#x7A0B;&#x62FF;&#x4FE1;&#x606F;</p>
<p><img src="../images/http_manager_1.png" alt="image"></p>
<h3 id="1-&#x6570;&#x636E;&#x4E0A;&#x62A5;">1. &#x6570;&#x636E;&#x4E0A;&#x62A5;</h3>
<p>&#x6240;&#x6709;&#x961F;&#x5217;&#xFF0C;&#x901A;&#x9053;&#x7B49;&#x8FDB;&#x961F;&#x5217;&#x90FD;&#x8981;&#x5B9A;&#x65F6;&#x7684;&#x5C06;&#x6570;&#x636E;&#x4E0A;&#x62A5;&#x7ED9;rabbit_mgmt_db &#x8FDB;&#x7A0B;&#x3002;</p>
<h4 id="a-&#x961F;&#x5217;&#x6570;&#x636E;&#x4E0A;&#x62A5;">A. &#x961F;&#x5217;&#x6570;&#x636E;&#x4E0A;&#x62A5;</h4>
<p>1). &#x8BBE;&#x7F6E;&#x4E0A;&#x62A5;&#x6570;&#x636E;&#x7684;&#x5B9A;&#x65F6;&#x5668;</p>
<p> ==&#x6BCF;&#x6B21;&#x5199;&#x5165;&#x6D88;&#x606F;&#x6216;&#x8005;ack&#x6D88;&#x606F;&#x7B49;&#x64CD;&#x4F5C;&#x7684;&#x65F6;&#x5019;&#x90FD;&#x4F1A;&#x786E;&#x4FDD;&#x4E00;&#x4E0B;&#x5B9A;&#x65F6;&#x5668;&#x662F;&#x5426;&#x5B58;&#x6D3B;==</p>
<p> &quot;&#x5B9A;&#x65F6;&#x53D1;&#x9001;&#x961F;&#x5217;&#x5806;&#x79EF;&#x7B49;&#x72B6;&#x6001;&#x4FE1;&#x606F;&#x7ED9;&#x7EDF;&#x8BA1;&#x6A21;&#x5757;&#x8FDB;&#x7A0B;&#x7684;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1; &quot;</p>
<p> &#x53EA;&#x8981;&#x4E0D;&#x5B58;&#x5728;&#x8FD9;&#x4E2A;&#x4EFB;&#x52A1;&#x5C31;&#x4F1A;&#x81EA;&#x52A8;&#x521B;&#x5EFA;. ==&#x5B9A;&#x65F6;&#x65F6;&#x95F4;&#x9ED8;&#x8BA4;&#x4E3A;5000ms. == &#x8FD9;&#x4E2A;&#x5B9A;&#x65F6;&#x65F6;&#x95F4;&#x7684;&#x503C;&#x53EF;&#x4EE5;&#x4E2A;&#x6027;</p>
<p> &#x53C2;&#x6570;&#x4E3A;:collect_statistics_interval(&#x5176;&#x4ED6;&#x6570;&#x636E;&#x4E0A;&#x62A5;&#x8FDB;&#x7A0B;&#x4E00;&#x6837;)</p>
<p>&#x4E0B;&#x9762;&#x662F;&#x4EE3;&#x7801; io:format&#x662F;&#x8C03;&#x8BD5;&#x6253;&#x7684;&#x65E5;&#x5FD7;</p>
<pre><code>ensure_stats_timer(C, P, Msg) -&gt;
    case element(P, C) of
        #state{level = Level, interval = Interval, timer = undefined} = State
          when Level =/= none -&gt;
            { {_, _, _}, {Hour, Minite, Second} } = calendar:local_time(),
            io:format(&quot;module:~p , pid:~p, P:~p,ensure_stats_timer Interval: ~p ,Msg:~p, toPid:~p, time: ~p : ~p : ~p ~n&quot;,[?MODULE,self(),P,Interval,Msg,self(),Hour,Minite,Second]),
            TRef = erlang:send_after(Interval, self(), Msg),
            setelement(P, C, State#state{timer = TRef});
        #state{} -&gt;
            C
    end.
</code></pre><h4 id="2-&#x961F;&#x5217;&#x8FDB;&#x7A0B;&#x5728;&#x8FDB;&#x5165;&#x72B6;&#x6001;&#x4E4B;&#x524D;&#x4E0A;&#x62A5;&#x6570;&#x636E;">2). &#x961F;&#x5217;&#x8FDB;&#x7A0B;&#x5728;&#x8FDB;&#x5165;&#x72B6;&#x6001;&#x4E4B;&#x524D;&#x4E0A;&#x62A5;&#x6570;&#x636E;</h4>
<p>&#x5047;&#x5982;&#x6BCF;&#x6B21;&#x53D1;&#x9001;&#x7684;&#x6570;&#x636E;&#x6BD4;&#x8F83;&#x5C11;,&#x961F;&#x5217;&#x8FDB;&#x7A0B;&#x5728;&#x8FDB;&#x5165;&#x72B6;&#x6001;&#x4E4B;&#x524D;,&#x4E5F;&#x4F1A;&#x8FDB;&#x884C;&#x53D1;&#x9001;&#x4E00;&#x6B21;&#x72B6;&#x6001;&#x4FE1;&#x606F;.&#x5E76;&#x4E14;&#x540C;&#x65F6;&#x6E05;&#x7A7A;&#x8FD9;&#x4E2A;&#x5806;&#x79EF;&#x72B6;&#x6001;&#x4E0A;&#x62A5;&#x7684;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;</p>
<pre><code class="lang-erlang">
<span class="hljs-function"><span class="hljs-title">handle_pre_hibernate</span><span class="hljs-params">(<span class="hljs-variable">State</span> = <span class="hljs-record_name">#q</span>{backing_queue = <span class="hljs-variable">BQ</span>,
                                backing_queue_state = <span class="hljs-variable">BQS</span>})</span> -&gt;</span>
    <span class="hljs-tuple">{<span class="hljs-variable">RamDuration</span>, <span class="hljs-variable">BQS1</span>}</span> = <span class="hljs-variable">BQ</span>:<span class="hljs-function_name">ram_duration</span>(<span class="hljs-variable">BQS</span>),
    <span class="hljs-variable">DesiredDuration</span> =
        <span class="hljs-function_name">rabbit_memory_monitor:report_ram_duration</span>(<span class="hljs-function_name">self</span>(), <span class="hljs-variable">RamDuration</span>),
    <span class="hljs-variable">BQS2</span> = <span class="hljs-variable">BQ</span>:<span class="hljs-function_name">set_ram_duration_target</span>(<span class="hljs-variable">DesiredDuration</span>, <span class="hljs-variable">BQS1</span>),
    <span class="hljs-variable">BQS3</span> = <span class="hljs-variable">BQ</span>:<span class="hljs-function_name">handle_pre_hibernate</span>(<span class="hljs-variable">BQS2</span>),
    <span class="hljs-function_name">rabbit_event:if_enabled</span>(
      <span class="hljs-variable">State</span>, <span class="hljs-record_name">#q</span>.stats_timer,
      <span class="hljs-keyword">fun</span> () -&gt; <span class="hljs-function_name">emit_stats</span>(<span class="hljs-variable">State</span>, [<span class="hljs-tuple">{idle_since,           <span class="hljs-function_name">now</span>()}</span>,
                                   <span class="hljs-tuple">{consumer_utilisation, &apos;&apos;}</span>]) <span class="hljs-keyword">end</span>),
    <span class="hljs-variable">State1</span> = <span class="hljs-function_name">rabbit_event:stop_stats_timer</span>(<span class="hljs-variable">State</span><span class="hljs-record_name">#q</span>{backing_queue_state = <span class="hljs-variable">BQS3</span>},
                                           <span class="hljs-record_name">#q</span>.stats_timer),

  <span class="hljs-tuple">{ <span class="hljs-tuple">{<span class="hljs-variable">_</span>, <span class="hljs-variable">_</span>, <span class="hljs-variable">_</span>}</span>, <span class="hljs-tuple">{<span class="hljs-variable">Hour</span>, <span class="hljs-variable">Minite</span>, <span class="hljs-variable">Second</span>}</span> }</span> = <span class="hljs-function_name">calendar:local_time</span>(),

  <span class="hljs-function_name">io:format</span>(<span class="hljs-string">&quot;module:~p , pid:~p, handle_pre_hibernate emit_stats and stop_stats_timer time: ~p : ~p : ~p ~n&quot;</span>,[?<span class="hljs-variable">MODULE</span>,<span class="hljs-function_name">self</span>(),<span class="hljs-variable">Hour</span>,<span class="hljs-variable">Minite</span>,<span class="hljs-variable">Second</span>]),
  <span class="hljs-tuple">{hibernate, <span class="hljs-function_name">stop_rate_timer</span>(<span class="hljs-variable">State1</span>)}</span>.
</code></pre>
<p>3). &#x5B9A;&#x65F6;&#x5668;&#x4E0A;&#x62A5;&#x6570;&#x636E;</p>
<p>&#x5047;&#x5982;&#x4E00;&#x76F4;&#x6709;&#x6570;&#x636E;&#x751F;&#x4EA7;&#x6216;&#x8005;&#x6D88;&#x8D39;&#x7B49;&#x64CD;&#x4F5C;,&#x5219;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;5&#x79D2;&#x540E;&#x751F;&#x6548;,&#x5F80;&#x7EDF;&#x8BA1;&#x6A21;&#x5757;&#x53D1;&#x9001;&#x4E00;&#x6761;&#x961F;&#x5217;&#x72B6;&#x6001;&#x4FE1;&#x606F;,&#x5E76;&#x6E05;&#x7A7A;&#x8FD9;&#x4E00;&#x4E2A;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;.&#x5F85;&#x4E0B;&#x4E00;&#x6B21;&#x751F;&#x4EA7;&#x6216;&#x8005;ack&#x7B49;&#x64CD;&#x4F5C;&#x7684;&#x65F6;&#x5019;&#x518D;&#x521B;&#x5EFA;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;</p>
<p>4). &#x6D4B;&#x8BD5;:</p>
<p>&#x6211;&#x4EEC;&#x7528;&#x4E00;&#x4E2A;&#x901A;&#x9053;&#x5F80; &#x4E00;&#x4E2A;&#x961F;&#x5217;&#x91CC;&#x5199;2&#x4E07;&#x6761;&#x6D88;&#x606F;</p>
<p>&#x6D4B;&#x8BD5;&#x5DE5;&#x5177;: <a href="https://github.com/jc3wish/RabbitMQTest" target="_blank">https://github.com/jc3wish/RabbitMQTest</a></p>
<p>&#x914D;&#x7F6E;&#x6587;&#x4EF6; 
[singleSend]</p>
<h1 id="&#x53EA;&#x5199;">&#x53EA;&#x5199;</h1>
<p>Method=single_send
Uri=amqp://guest:guest@127.0.0.1:35673/testvhost
ExchangeName=amq.direct
RoutingKey=testQueue</p>
<h1 id="&#x5199;&#x5165;&#x7B49;&#x5F85;&#x8FD4;&#x56DE;&#x591A;&#x4E45;">&#x5199;&#x5165;&#x7B49;&#x5F85;&#x8FD4;&#x56DE;&#x591A;&#x4E45;</h1>
<p>WriteTimeOut=10
DeliveryMode=2</p>
<h1 id="&#x5199;&#x5165;&#x7684;&#x6570;&#x636E;&#x5927;&#x5C0F;&#x591A;&#x4E2A;&#x7528;&#x9017;&#x53F7;&#x9694;&#x5F00;&#x968F;&#x673A;&#x5199;&#x5165;&#x5355;&#x4F4D;byte">&#x5199;&#x5165;&#x7684;&#x6570;&#x636E;&#x5927;&#x5C0F;,&#x591A;&#x4E2A;&#x7528;&#x9017;&#x53F7;&#x9694;&#x5F00;,&#x968F;&#x673A;&#x5199;&#x5165;,&#x5355;&#x4F4D;byte</h1>
<p>DataSize=512</p>
<h1 id="&#x8FDE;&#x63A5;&#x6570;">&#x8FDE;&#x63A5;&#x6570;</h1>
<p>ConnectCount=1</p>
<h1 id="&#x6BCF;&#x4E2A;&#x8FDE;&#x63A5;&#x5F00;&#x542F;&#x591A;&#x4E2A;&#x901A;&#x9053;">&#x6BCF;&#x4E2A;&#x8FDE;&#x63A5;&#x5F00;&#x542F;&#x591A;&#x4E2A;&#x901A;&#x9053;</h1>
<p>ChannelCount=1</p>
<h1 id="&#x6BCF;&#x4E2A;&#x901A;&#x9053;&#x603B;&#x7684;&#x5199;&#x5165;&#x591A;&#x5C11;&#x6761;&#x6570;&#x636E;">&#x6BCF;&#x4E2A;&#x901A;&#x9053;&#x603B;&#x7684;&#x5199;&#x5165;&#x591A;&#x5C11;&#x6761;&#x6570;&#x636E;</h1>
<p>ChanneWriteCount=20000</p>
<h1 id="&#x5F00;&#x542F;&#x8FD4;&#x56DE;confirm&#x6A21;&#x5F0F;">&#x5F00;&#x542F;&#x8FD4;&#x56DE;confirm&#x6A21;&#x5F0F;</h1>
<p>WaitConfirm=1</p>
<p>&#x542F;&#x52A8;:
./RabbitMQTest -c etc/config.ini -key singleSend</p>
<p>RabbitMQ&#x8981;&#x65E5;&#x5FD7;&#x6253;&#x5370;&#x4FE1;&#x606F;:</p>
<p><img src="../images/http_manager_test_1.png" alt="image"></p>
<p><img src="../images/http_manager_test_2.png" alt="image"></p>
<h4 id="b-&#x8FDE;&#x63A5;&#x4FE1;&#x606F;&#x4E0A;&#x62A5;">B. &#x8FDE;&#x63A5;&#x4FE1;&#x606F;&#x4E0A;&#x62A5;</h4>
<p>&#x8FDE;&#x63A5;&#x5728;&#x521B;&#x5EFA; ,&#x5173;&#x95ED;&#x7B49;&#x64CD;&#x4F5C;&#x7684;&#x65F6;&#x5019; ,&#x4F1A;&#x7ACB;&#x5373;&#x5F80;&#x7EDF;&#x8BA1;&#x6A21;&#x5757;&#x53D1;&#x9001;&#x4E00;&#x6B21;&#x72B6;&#x6001;&#x4FE1;&#x606F;</p>
<p>&#x5728;&#x8FDE;&#x63A5;&#x6210;&#x529F;&#x540E;,&#x4E5F;&#x505A;&#x4E2A;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;,5&#x79D2;&#x53D1;&#x8D77;&#x4E00;&#x4E2A;&#x8FDE;&#x63A5;&#x72B6;&#x6001;&#x4FE1;&#x606F;&#x53D1;&#x9001;&#x7ED9;&#x7EDF;&#x8BA1;&#x6A21;&#x5757;</p>
<p>&#x8FDE;&#x63A5;&#x72B6;&#x6001;&#x4FE1;&#x606F;&#x5305;&#x62EC;
&#x8FDE;&#x63A5;&#x540D;&#x79F0;,&#x8F93;&#x5165;&#x5927;&#x5C0F;,&#x8F93;&#x51FA;&#x5927;&#x5C0F;,&#x8FDE;&#x63A5;&#x5E10;&#x53F7;&#x7B49;&#x57FA;&#x672C;&#x4FE1;&#x606F;</p>
<p>&#x76F8;&#x5173;&#x4EE3;&#x7801;:rabbit_reader.erl</p>
<h4 id="c-&#x901A;&#x9053;&#x4FE1;&#x606F;&#x4E0A;&#x62A5;">C. &#x901A;&#x9053;&#x4FE1;&#x606F;&#x4E0A;&#x62A5;</h4>
<p>&#x901A;&#x9053;&#x548C;&#x8FDE;&#x63A5;&#x4E00;&#x6837;,&#x5728;&#x521B;&#x5EFA; &#x548C; &#x5173;&#x95ED;&#x7684;&#x65F6;&#x5019;,&#x4EE5;&#x53CA; &#x6BCF;5&#x79D2;&#x4F1A;&#x4E0A;&#x62A5;&#x4E00;&#x6B21;</p>
<p>&#x5E76;&#x4E14;&#x901A;&#x9053;&#x8FDB;&#x7A0B;&#x5728;&#x4F11;&#x7720;&#x4E4B;&#x524D;&#x4E5F;&#x4F1A;&#x4E0A;&#x62A5;&#x4E00;&#x6B21;,&#x8FDE;&#x63A5;&#x6A21;&#x5757;&#x662F;&#x6CA1;&#x4F11;&#x7720;&#x7684;</p>
<p>&#x901A;&#x9053;&#x6CA1;&#x6709;&#x8F93;&#x5165;,&#x8F93;&#x51FA;&#x5927;&#x5C0F;&#x6570;&#x636E;&#x7684;&#x4E0A;&#x62A5;</p>
<p>&#x76F8;&#x5173;&#x4EE3;&#x7801;: rabbit_channel.erl</p>
<h4 id="d-&#x8282;&#x70B9;&#x72B6;&#x6001;&#x4FE1;&#x606F;&#x4E0A;&#x62A5;">D. &#x8282;&#x70B9;&#x72B6;&#x6001;&#x4FE1;&#x606F;&#x4E0A;&#x62A5;</h4>
<p>RabbitMQ Manager&#x63D2;&#x4EF6;&#x91CC;&#x7684; rabbit_mgmt_external_stats &#x8FDB;&#x884C;&#x5B9A;&#x65F6;5&#x79D2;&#x4E0A;&#x62A5;&#x6570;&#x636E;&#x5230;  rabbit_mgmt_db &#x8FDB;&#x7A0B;. </p>
<p>==rabbit_mgmt_external_stats  &#x8FDB;&#x7A0B;&#x68C0;&#x6D4B;&#x548C;rabbit_node_mointor&#x8FDB;&#x7A0B;&#x6CA1;&#x6709;&#x76F4;&#x63A5;&#x5173;&#x7CFB; . rabbit_node_monitor&#x8FDB;&#x7A0B;&#x662F;&#x7528;&#x68C0;&#x6D4B;&#x8282;&#x70B9;&#x662F;&#x5426;&#x53EF;&#x7528;,&#x5F53;&#x8282;&#x70B9;&#x8D77;&#x6765;&#x6216;&#x8005;&#x5B95;&#x673A;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x4E3B;&#x52A8;&#x5F80;  rabbit_mgmt_db &#x8FDB;&#x7A0B; &#x4E0A;&#x6B21;&#x4E00;&#x6B21;&#x6570;&#x636E; .==</p>
<p>==rabbit_mgmt_external_stats  &#x8FDB;&#x7A0B;&#x4E3B;&#x8981;&#x662F;&#x5B9A;&#x65F6;&#x66F4;&#x65B0;&#x8282;&#x70B9;&#x4FE1;&#x606F;==</p>
<h4 id="e-&#x5176;&#x4ED6;&#x6570;&#x636E;&#x4E0A;&#x62A5;">E. &#x5176;&#x4ED6;&#x6570;&#x636E;&#x4E0A;&#x62A5;</h4>
<p>vhost, queue, exchange &#x5728;&#x521B;&#x5EFA;,&#x5220;&#x9664;&#x7684;&#x65F6;&#x5019; &#x4E5F;&#x4F1A;&#x5F80; rabbit_mgmt_db &#x8FDB;&#x7A0B;&#x4E0A;&#x62A5;&#x6570;&#x636E;. </p>
<p>queue&#x548C;exchange&#x4FE1;&#x606F;&#x4E0A;&#x62A5;&#x7684;&#x65F6;&#x5019; &#x90FD; &#x4F1A;&#x5E26;&#x4E0A;vhost&#x540D;&#x79F0;. </p>
<p>&#x56E0;&#x4E3A;&#x5728;rabbit_mgmt_db &#x8FDB;&#x7A0B;&#x6570;&#x636E;&#x5B58;&#x50A8;&#x7684;&#x65F6;&#x5019;,&#x662F;&#x4EE5; vhost &#x4E3A;&#x7B2C;&#x4E00;&#x7EF4;&#x5EA6;.</p>
<h3 id="2-&#x6570;&#x636E;&#x5B58;&#x50A8;&#x53CA;&#x8BFB;&#x53D6;">2. &#x6570;&#x636E;&#x5B58;&#x50A8;&#x53CA;&#x8BFB;&#x53D6;</h3>
<p>&#x4E0D;&#x540C;&#x7684;&#x6570;&#x636E;&#x7C7B;&#x578B;,&#x662F;&#x5B58;&#x50A8; &#x5728;&#x4E0D;&#x540C;&#x7684;&#x6570;&#x636E;&#x8868;&#x91CC;&#x7684;,</p>
<p>&#x4F8B;&#x5982;:</p>
<ul>
<li>queue_stats</li>
<li>connection_stats</li>
<li>channel_stats</li>
<li>consumers_by_queue</li>
<li>consumers_by_channel</li>
<li>node_stats</li>
<li>node_node_stats</li>
</ul>
<p>&#x4EE5;&#x4E0A;&#x8868;&#x4FDD;&#x5B58;&#x7684;&#x662F;&#x6BCF;&#x4E2A;&#x961F;&#x5217;&#x7684;&#x6700;&#x65B0;&#xFF0C;&#x6216;&#x8005;&#x8282;&#x70B9;&#x6700;&#x65B0;&#x7684;&#x4FE1;&#x606F;</p>
<p>aggregated_stats &#x8868;&#x91CC;&#x5B58;&#x7684;&#x662F; &#x5386;&#x53F2;&#x4FE1;&#x606F;&#xFF0C;&#x7528;&#x4E8E;&#x66F2;&#x7EBF; &#x5C55;&#x793A;&#x6240;&#x7528;</p>
<p>&#x961F;&#x5217;,&#x8FDE;&#x63A5;&#x7B49;&#x90FD;&#x662F;&#x4EE5;vhost &#x505A;&#x4E3A;&#x7B2C;&#x4E00;&#x7EF4;&#x5EA6;&#x8FDB;&#x884C;&#x5B58;&#x50A8; . </p>
<p>&#x6BCF;&#x6B21;overview API&#x53BB;&#x8BFB;&#x53D6;&#x4FE1;&#x606F;&#x7684;&#x65F6;&#x5019; ,&#x90FD;&#x662F;&#x5148;&#x627E;&#x5230;&#x8981;&#x4ECE;&#x54EA;&#x4E9B;vhost&#x8BFB;&#x53D6;&#x4FE1;&#x606F;</p>
<p>&#x56E0;&#x4E3A;&#x53EF;&#x80FD;&#x4E0D;&#x540C;&#x72B6;&#x6001;,&#x80FD;&#x8BBF;&#x95EE;&#x7684;vhost&#x53EF;&#x80FD;&#x4E0D;&#x4E00;&#x6837;</p>
<p>&#x6BCF;&#x6B21;&#x961F;&#x5217;&#x5806;&#x79EF;&#x7B49;&#x4FE1;&#x606F;&#x6570;&#x636E;&#x4E0A;&#x62A5;,&#x90FD;&#x662F;&#x5F80; queue_stats &#x8868;&#x91CC;&#x8FFD;&#x52A0;&#x4E00;&#x6761;&#x4FE1;&#x606F;.</p>
<p>==&#x4F46;&#x8FDB;&#x884C;&#x8BFB;&#x53D6;&#x7CFB;&#x7EDF;&#x6574;&#x4E2A;&#x5806;&#x79EF;&#x66F2;&#x7EBF;&#x7684;&#x65F6;&#x5019; ,&#x662F;&#x67E5;&#x627E;&#x51FA;&#x6240;&#x6709;vhost,&#x7136;&#x540E;&#x8FDB;&#x884C;&#x904D;&#x5386;queue_stats&#x8868;&#x91CC;&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x961F;&#x5217;&#x7684;&#x5806;&#x79EF;&#x7684;&#x6BCF;&#x4E00;&#x6761;&#x4FE1;&#x606F;==</p>
<p>&#x6BCF;&#x4E2A;VHOST&#x7684;&#x5806;&#x79EF;&#x60C5;&#x51B5;&#x5728;rabbit_mgmt_db &#x8FDB;&#x7A0B;&#x91CC;&#x7684;&#x5B58;&#x50A8;&#x683C;&#x5F0F;&#x5982;&#x4E0B;:</p>
<pre><code>[{messages,
                {stats,
                    {5,
                     {1548818465000,10,nil,
                      {1548818470000,0,nil,
                       {1548818505000,1,nil,
                        {1548818520000,1,nil,{1548818545000,1,nil,nil} } } } } },
                    0} },
            {messages_ready,
                {stats,
                    {5,
                     {1548818465000,10,nil,
                      {1548818470000,0,nil,
                       {1548818505000,1,nil,
                        {1548818520000,1,nil,{1548818545000,1,nil,nil} } } } } },
                    0} },
            {messages_unacknowledged,
                {stats,
                    {5,
                     {1548818465000,0,nil,
                      {1548818470000,0,nil,
                       {1548818505000,0,nil,
                        {1548818520000,0,nil,{1548818545000,0,nil,nil} } } } } },
                    0} }]:
</code></pre><p>&#x6BCF;&#x6B21;&#x66F4;&#x65B0;&#x961F;&#x5217;&#x4FE1;&#x606F;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4E5F;&#x4F1A;&#x66F4;&#x65B0;VHOST &#x5BF9;&#x5E94;&#x7684;ETS&#x8868;&#x91CC;&#x7684;&#x7EDF;&#x8BA1;&#x4FE1;&#x606F;</p>
<p>&#x6BCF;&#x4E2A;VHOST&#x90FD;&#x662F;&#x6309;&#x8FD9;&#x6837;&#x7684;&#x65F6;&#x95F4;&#x6233;&#x4FDD;&#x5B58;&#x7740;&#xFF0C;&#x5E76;&#x4E14;&#x540C;&#x4E00;&#x65F6;&#x95F4;&#x70B9;&#xFF0C;&#x4FDD;&#x5B58;&#x4E86;&#x4E09;&#x6761;&#x6570;&#x636E;</p>
<p>&#x6BCF;&#x4E2A;&#x961F;&#x5217;&#x4E00;&#x6837;&#x5806;&#x79EF;&#x60C5;&#x51B5;&#x4E5F;&#x662F;&#x4E00;&#x6837;&#xFF0C;&#x6BCF;&#x4E2A;&#x65F6;&#x95F4;&#x6233;&#x4FDD;&#x5B58;&#x4E09;&#x6761;&#x6570;&#x636E;</p>
<p>&#x5176;&#x5B9E;&#x5728;rabbit_mgmt_db &#x8FDB;&#x7A0B;&#x6240;&#x6709;&#x6709;&#x5173;&#x5386;&#x53F2;&#x6570;&#x636E;&#x7684;&#x4FDD;&#x5B58;&#x5168;&#x662F;&#x6309;&#x8FD9;&#x79CD;&#x65F6;&#x95F4;&#x6233;&#x7684;&#x65B9;&#x5F0F;&#x4FDD;&#x5B58;</p>
<p>&#x5728;http API&#x53BB;&#x83B7;&#x53D6;&#x5386;&#x53F2;&#x6570;&#x636E;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6BD4;&#x5982;</p>
<blockquote>
<p><a href="http://10.40.2.41:15674/api/overview?lengths_age=600&amp;lengths_incr=5&amp;msg_rates_age=600&amp;msg_rates_incr=5" target="_blank">http://10.40.2.41:15674/api/overview?lengths_age=600&amp;lengths_incr=5&amp;msg_rates_age=600&amp;msg_rates_incr=5</a></p>
</blockquote>
<p>&#x4EE5;&#x4E0A;API &#x662F;&#x83B7;&#x53D6;&#x6574;&#x4E2A;&#x96C6;&#x7FA4;&#x6700;&#x8FD1;10&#x5206;&#x949F;&#x7684;&#x6570;&#x636E;</p>
<p>==&#x5728;&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x4F1A;&#x904D;&#x5386;vhost&#x5BF9;&#x5E94;&#x7684;ETS&#x8868;&#x7684;&#x5386;&#x53F2;&#x6570;&#x636E;&#xFF0C;&#x540C;&#x4E00;&#x65F6;&#x95F4;&#x6233;&#x7684;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x7D2F;&#x52A0;
&#x7136;&#x540E;&#x745E;&#x904D;&#x5386;&#x7ED3;&#x679C;&#x5224;&#x65AD;&#x662F;&#x5426;&#x5C5E;&#x4E8E; rates &#x6982;&#x5FF5;&#x8303;&#x56F4;&#x7684;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x53D6;&#x6837;&#x3002;==</p>
<h3 id="3-&#x961F;&#x5217;&#x5806;&#x79EF;&#x6570;&#x636E;&#x6E05;&#x9664;">3. &#x961F;&#x5217;&#x5806;&#x79EF;&#x6570;&#x636E;&#x6E05;&#x9664;</h3>
<p>&#x65E2;&#x7136;&#x6BCF;&#x4E2A;&#x961F;&#x5217;&#x6BCF;&#x6B21;&#x4E0A;&#x62A5;&#x4E00;&#x6B21;&#x6570;&#x636E;,&#x5C31;&#x5F80; queue_stats &#x8868;&#x91CC;&#x63D2;&#x5165;&#x4E00;&#x6761;&#x6570;&#x636E;,&#x90A3;&#x6570;&#x636E;&#x5C31;&#x4F1A;&#x8D8A;&#x6765;&#x8D8A;&#x591A;</p>
<p>==&#x6240;&#x4EE5; rabbit_mgmt_db  &#x8FDB;&#x7A0B;&#x5728;&#x542F;&#x52A8;&#x7684;&#x65F6;&#x5019;,&#x5C31;&#x505A;&#x4E00;&#x4E2A;5000ms &#x7684;&#x5B9A;&#x65F6;&#x4EFB;&#x52A1;, &#x5B9A;&#x65F6;&#x7684;&#x5F80; &#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x53D1;&#x9001;&#x4E00;&#x6761;&#x5185;&#x5BB9;&#x4E3A;&quot;gc&quot;&#x7684;&#x6307;&#x4EE4;==</p>
<p>&#x8FD9;&#x4E2A;&#x5B9A;&#x65F6;&#x65F6;&#x95F4;&#x5728;&#x6BD4;&#x8F83;&#x4F4E;&#x7248;&#x672C;&#x7684;RabbitMQ&#x6E90;&#x7801;&#x4E2D;&#x662F;&#x4E0D;&#x80FD;&#x4FEE;&#x6539;&#x7684;. </p>
<p>&#x4F46;&#x662F;gc &#x7B56;&#x7565;&#x662F;&#x53EF;&#x4EE5;&#x4FEE;&#x6539;. &#x548C; rates_mode
&#x540C;&#x7EA7;&#x914D;&#x7F6E;&#x3002;</p>
<p>&#x4F46;&#x662F;&#x9AD8;&#x7248;&#x672C;&#x53EF;&#x80FD;&#x5DF2;&#x7ECF;&#x6539;&#x6389;&#xFF0C;&#x5728;&#x4F4E;&#x7248;&#x672C;&#x662F;&#x8FD9;&#x6837;&#x7684;gc&#x7B56;&#x7565;&#x3002;&#x5E76;&#x4E14;&#x8FD9;&#x4E2A;<strong>&#x4E0D;&#x8981;&#x81EA;&#x4F5C; &#x806A;&#x660E;&#x54E6;&#xFF0C;&#x6700;&#x597D;&#x4E0D;&#x8981;&#x53BB;&#x4FEE;&#x6539;&#x3002;</strong>
&#x4E0B;&#x9762;&#x662F;rabbitmq&#x7684;&#x9ED8;&#x8BA4;&#x914D;&#x7F6E;</p>
<pre><code>{sample_retention_policies,
  %% List of {MaxAgeInSeconds, SampleEveryNSeconds}
  [{global,   [{605, 5}, {3660, 60}, {29400, 600}, {86400, 1800}]},
   {basic,    [{605, 5}, {3600, 60}]},
   {detailed, [{10, 5}]}]}
]}
</code></pre><ul>
<li><strong>global</strong> : &#x8282;&#x70B9;&#x4FE1;&#x606F;&#xFF0C;VHOST&#x4FE1;&#x606F; &#x6309;&#x8FD9;&#x4E2A;&#x914D;&#x7F6E;&#x8FDB;&#x884C;gc</li>
<li><strong>basic</strong>:  &#x961F;&#x5217;&#xFF0C;&#x4EA4;&#x6362;&#x673A;&#xFF0C;&#x8FDE;&#x63A5;&#xFF0C;&#x901A;&#x9053; &#x4FE1;&#x606F;&#x6309; &#x8FD9;&#x4E2A;&#x914D;&#x7F6E;&#x8FDB;&#x884C;gc</li>
<li><strong>detailed</strong>: &#x5176;&#x4ED6;&#x4FE1;&#x606F;&#x6309; &#x8FD9;&#x4E2A;&#x914D;&#x7F6E;&#x8FDB;&#x884C;gc,</li>
</ul>
<p>&#x6BCF;&#x6761;&#x4FE1;&#x606F;&#x90FD;&#x548C;&#x76F8;&#x5BF9;&#x5E94;&#x7684;gc&#x7B56;&#x7565;&#x7684;&#x914D;&#x7F6E;&#x8FDB;&#x884C;&#x5BF9;&#x6BD4;&#xFF0C;&#xFF5B;x,y&#xFF5D;&#x7684;&#x914D;&#x7F6E;
Now-TS &lt;= X * 1000&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x8FDB;&#x884C;&#x4FDD;&#x5B58;&#xFF0C;&#x6216;&#x8005;&#x8FDB;&#x884C;&#x6570;&#x636E;&#x5408;&#x5E76;&#x3002;&#x5426;&#x5219;&#x8FDB;&#x884C;&#x5220;&#x9664;&#x3002;</p>
<p>&#x6BD4;&#x5982;&#x961F;&#x5217;&#x4FE1;&#x606F;&#xFF0C;&#x7B2C;&#x4E00;&#x6B21;&#x7B56;&#x7565;605,5 &#x7684;&#x914D;&#x7F6E;&#xFF0C;&#x7B2C;&#x4E00;&#x6B21;&#x904D;&#x5386;&#x53EF;&#x80FD;&#x662F;&#x5408;&#x5E76;&#x5230;&#x4E0B;&#x6761;&#x6570;&#x636E;&#xFF0C;&#x4F46;&#x662F;&#x7ECF;&#x8FC7;86400 &#x4E4B;&#x540E;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;1&#x5929;&#xFF0C;&#x5C31;&#x4E0D;&#x4F1A;&#x518D;&#x5408;&#x5E76;&#x4E86;&#xFF0C;&#x53EA;&#x4F1A;&#x6709;&#x5220;&#x9664;&#x3002;</p>
<p>&#x8FD9;&#x4E5F;&#x5C31;&#x662F;&#x4E3A;&#x4EC0;&#x4E48;&#x7BA1;&#x7406;&#x754C;&#x9762;&#x4E0A;&#x6700;&#x5927;&#x53EA;&#x80FD;&#x67E5;&#x770B;&#x5230;&#x6700;&#x8FD1;&#x4E00;&#x5929;&#x7684;&#x6570;&#x636E;&#x4E86;</p>
<p>&#x76F8;&#x5173;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code>set_gc_timer(State) -&gt;
 TRef = erlang:send_after(?GC_INTERVAL, self(), gc),
 State#state{gc_timer = TRef}.


handle_info(gc, State) -&gt;
    noreply(set_gc_timer(gc_batch(State)));



gc_batch(State = #state{aggregated_stats = ETS}) -&gt;
 {ok, Policies} = application:get_env(
        rabbitmq_management, sample_retention_policies),
 Rows = erlang:max(?GC_MIN_ROWS,
       round(?GC_MIN_RATIO * ets:info(ETS, size))),
 gc_batch(Rows, Policies, State).


gc_batch(0, _Policies, State) -&gt;
 State;
gc_batch(Rows, Policies, State = #state{aggregated_stats = ETS,
          gc_next_key      = Key0}) -&gt;
 Key = case Key0 of
     undefined -&gt; ets:first(ETS);
     _         -&gt; ets:next(ETS, Key0)
    end,
 Key1 = case Key of
      &apos;$end_of_table&apos; -&gt; undefined;
      _               -&gt; Now = floor(os:timestamp(), State),
          Stats = ets:lookup_element(ETS, Key, 2),
          gc(Key, Stats, Policies, Now, ETS),
          Key
     end,
 gc_batch(Rows - 1, Policies, State#state{gc_next_key = Key1}).


gc({ { Type, Id }, Key}, Stats, Policies, Now, ETS) -&gt;
 Policy = pget(retention_policy(Type), Policies),
 case rabbit_mgmt_stats:gc({Policy, Now}, Stats) of
  Stats  -&gt; ok;
  Stats2 -&gt; ets:insert(ETS, { { { Type, Id }, Key}, Stats2})
 end.
</code></pre><h3 id="4-statisticsdbeventqueue">4. statistics_db_event_queue</h3>
<p>&#x5728;RabbitMQ Manager&#x63D2;&#x4EF6;&#x7BA1;&#x7406;&#x754C;&#x9762;&#x9996;&#x9875;&#x91CC;,&#x53EF;&#x80FD;&#x4F1A;&#x51FA;&#x73B0; &#x8B66;&#x544A;</p>
<blockquote>
<p>The management statistics database currently has a queue of xx events to process. If this number keeps increasing, so will the memory used by the management plugin. You may find it useful to set the rates_mode config item to none.</p>
</blockquote>
<p>&#x8FD9;&#x4E2A;&#x8B66;&#x544A;&#x91CC;&#x7684; xx &#x503C;&#x5C31;&#x662F;  overview api &#x91CC;&#x83B7;&#x53D6;&#x8FD4;&#x56DE;&#x7684; statistics_db_event_queue &#x503C;. </p>
<p>&#x5F53;&#x8FD9;&#x4E2A;&#x503C;&#x5927;&#x4E8E;1000&#x7684;&#x65F6;&#x5019; &#x4F1A;&#x8FDB;&#x884C;&#x5728;&#x754C;&#x9762;&#x4E0A;&#x663E;&#x793A;&#x51FA;&#x6765;.</p>
<p>&#x8FD9;&#x4E2A;&#x503C;&#x662F;&#x8868;&#x793A;  ==rabbit_mgmt_db &#x8FDB;&#x7A0B;&#x91CC;&#x5F85;&#x5904;&#x7406;&#x5176;&#x4ED6;&#x8FDB;&#x7A0B;&#x53D1;&#x9001;&#x8FC7;&#x6765;&#x7684;&#x6570;&#x636E;&#x7684;&#x961F;&#x5217;&#x957F;&#x5EA6;.==</p>
<p>&#x5305;&#x62EC;&#x961F;&#x5217;, &#x901A;&#x9053;,&#x8FDE;&#x63A5;&#x53CA;&#x8282;&#x70B9;&#x72B6;&#x6001;&#x7B49;&#x8FDB;&#x7A0B;&#x4E0A;&#x62A5;&#x6570;&#x636E;&#x7ED9;  rabbit_mgmt_db  &#x7684;&#x4E0A;&#x62A5;&#x6570;&#x636E;&#x4EE5;&#x53CA; API&#x8BF7;&#x6C42;&#x6570;&#x636E;. </p>
<p>&#x4F46;&#x8FD9;&#x91CC;&#x5E76;&#x4E0D;&#x5305;&#x62EC; &quot;gc&quot;&#x547D;&#x4EE4;</p>
<p>&#x6BD4;&#x5982;&#x6BCF;&#x6B21;&#x961F;&#x5217;&#x4E0A;&#x6B21;&#x4E00;&#x6570;&#x636E;&#x961F;&#x5217;&#x957F;&#x5EA6;&#x5C31;&#x4F1A; + 1</p>
<p>HTTP api &#x8C03;&#x7528;/api/overview&#x63A5;&#x53E3;,&#x6216;&#x8005;&#x8C03;&#x7528;/api/queues &#x63A5;&#x53E3;&#x7684;&#x65F6;&#x5019; ,&#x961F;&#x5217;&#x957F;&#x5EA6;&#x4E5F;&#x4F1A; +1</p>
<p>&#x5F53;&#x7136;&#x6BCF;&#x6B21;&#x5904;&#x7406;&#x5B8C;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42; &#x961F;&#x5217;&#x957F;&#x5EA6; &#x5C31;&#x4F1A;  -1</p>
<p>&#x8FD9;&#x4E2A;&#x961F;&#x5217;&#x957F;&#x5EA6;&#x662F;&#x7531;erlang&#x672C;&#x8EAB;&#x7EDF;&#x8BA1;&#x7684;. &#x5E76;&#x4E0D;&#x662F;&#x7531;RabbitMQ&#x4E1A;&#x52A1;&#x4EE3;&#x7801;&#x5B9E;&#x73B0;&#x7684;.</p>
<pre><code>%% We want timely replies to queries even when overloaded, so return 5
%% as priority. Also we only have access to the queue length here, not
%% in handle_call/3, so stash it in the dictionary. This is a bit ugly
%% but better than fiddling with gen_server2 even more.
prioritise_call(_Msg, _From, Len, _State) -&gt;
 put(last_queue_length, Len),
</code></pre><p>prioritise_call &#x662F;&#x5F53;erlang&#x91CC;&#x91C7;&#x7528;gen-server &#x8C03;&#x7528;&#x65F6;&#x5019;,&#x4F1A;&#x8FDB;&#x884C;&#x56DE;&#x8C03;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;.&#x5E76;&#x8FD4;&#x56DE;&#x5F53;&#x524D;&#x4FE1;&#x606F;&#x7684;&#x6743;&#x91CD;&#x5927;&#x5C0F;.&#x8FD9;&#x91CC;&#x8FD4;&#x56DE;&#x7684;&#x6743;&#x91CD;&#x5927;&#x5C0F;&#x662F;&#x8FD4;&#x56DE;&#x7684;&#x503C;&#x8D8A;&#x5927;,&#x6743;&#x91CD;&#x8D8A;&#x9AD8;.  </p>
<p>&#x6211;&#x4EEC;&#x4E0A;&#x9762;&#x4E5F;&#x8BF4;&#x4E86; &#x961F;&#x5217;&#x5806;&#x79EF;&#x4FE1;&#x606F;&#x5B58;&#x50A8;&#x662F;&#x6309;&#x65F6;&#x95F4;&#x6233;&#x4E00;&#x6761;&#x4E00;&#x6761;&#x5B58;&#x50A8;&#x7684;.</p>
<p>&#x5728;&#x8BFB;&#x53D6;&#x7684;&#x65F6;&#x5019;&#x8FDB;&#x884C;&#x904D;&#x5386;&#x8FC7;&#x6EE4;. </p>
<p>&#x518D;&#x9760;gc&#x6307;&#x4EE4;&#x5C06;&#x4E0D;&#x8981;&#x7684;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x6E05;&#x9664;.</p>
<blockquote>
<p>&#x5047;&#x5982;&#x6211;&#x4EEC;&#x6709;&#x5927;&#x91CF;&#x961F;&#x5217;&#x7684;&#x6570;&#x636E;&#x90FD;&#x5728;&#x5199;&#x5165;&#x6216;&#x8005;&#x8FDE;&#x63A5;&#x77AC;&#x95F4;&#x91CD;&#x8FDE;&#x5F88;&#x591A;&#x7684;&#x60C5;&#x51B5;&#x7684;&#x60C5;&#x51B5;&#x4E0B;,</p>
<p>rabbit_mgmt_db &#x8FDB;&#x7A0B;&#x91CC;&#x7684;&#x5B58;&#x50A8;&#x7684;&#x6570;&#x636E;&#x4E5F;&#x8D8A;&#x6765;&#x8D8A;&#x591A;,&#x5E76;&#x4E14; &#x7B49;&#x5F85; rabbit_mgmt_db &#x8FDB;&#x7A0B;&#x5904;&#x7406;&#x7684;&#x961F;&#x5217;&#x4FE1;&#x606F;&#x4E5F;&#x53D8;&#x5F97;&#x8D8A;&#x6765;&#x8D8A;&#x591A;</p>
</blockquote>
<p>&#x8FD9;&#x6837;&#x5C31;&#x4F1A;&#x9020;&#x6210;  rabbit_mgmt_db &#x8FDB;&#x7A0B;&#x6240;&#x5728;&#x8282;&#x70B9;&#x5185;&#x5B58;&#x7206;&#x6DA8;.</p>
<p>&#x9020;&#x6210;&#x7BA1;&#x7406;&#x754C;&#x9762;&#x8BBF;&#x95EE;&#x4E0D;&#x4E86;,API&#x8BBF;&#x95EE;&#x4E0D;&#x4E86;, &#x4E25;&#x91CD;&#x5219;&#x9020;&#x6210;&#x5B95;&#x673A;&#x7B49;&#x60C5;&#x51B5;</p>
<p>&#x6240;&#x4EE5;==&#x505A;&#x597D;   statistics_db_event_queue &#x503C;&#x7684;&#x76D1;&#x63A7;&#x5F88;&#x6709;&#x5FC5;&#x8981;.==</p>
<p>&#x4F46;&#x8FD9;&#x91CC;&#x8981;&#x6CE8;&#x610F;&#x4E00;&#x4E0B;,&#x8FD9;&#x4E2A;&#x5730;&#x65B9;&#x76D1;&#x63A7;&#x8FD8;&#x662F;&#x4F9D;&#x61D2;http&#x63A5;&#x53E3;.&#x6240;&#x4EE5;&#x5728;&#x505A;&#x8FD9;&#x4E2A;&#x76D1;&#x63A7;&#x7684;&#x65F6;&#x5019;&#x8981;&#x6CE8;&#x610F;&#x628A;&#x63E1;&#x4E00;&#x4E2A;&#x5EA6;</p>
<p>&#x5982;&#x679C; statistics_db_event_queue  &#x5F88;&#x5927;&#x7684;&#xFF0C;&#x5F71;&#x54CD;&#x4E86;&#x670D;&#x52A1;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x9700;&#x8981;&#x624B;&#x5DE5;&#x5728;&#x628A; rabbit_mgmt_db &#x8FD9;&#x4E2A;&#x8FDB;&#x7A0B;&#x7ED9;&#x5E72;&#x6389;&#xFF0C;&#x8BA9;&#x8FD9;&#x4E2A;&#x8FDB;&#x7A0B;&#x91CD;&#x542F;&#x4E00;&#x4E0B;. </p>
<p>&#x5982;&#x679C;&#x662F;&#x662F;&#x96C6;&#x7FA4;&#x7684;&#x8BDD;&#xFF0C;&#x5F97;&#x53BB; &#x5E26;&#x6709; Stats &#x6807;&#x8BC6;&#x7684;&#x7ED3;&#x70B9;&#x4E0A;&#x8FD0;&#x884C;&#x4E0B;&#x9762;&#x7684;&#x547D;&#x4EE4;</p>
<p><img src="../images/http_manager_2.png" alt="image"></p>
<p><strong>3.6.2&#x4EE5;&#x524D;&#x7684;&#x7248;&#x672C;&#xFF1A;</strong></p>
<pre><code>rabbitmqctl eval &apos;exit(erlang:whereis(rabbit_mgmt_db), please_terminate).&apos;
</code></pre><p><strong>3.6.2,3.6.2&#x4EE5;&#x540E;&#x7684;&#x7248;&#x672C;&#xFF1A;</strong></p>
<pre><code>rabbitmqctl eval &apos;supervisor2:terminate_child(rabbit_mgmt_sup_sup, rabbit_mgmt_sup),rabbit_mgmt_sup_sup:start_child().&apos;
</code></pre><h3 id="&#x5C0F;&#x7ED3;">&#x5C0F;&#x7ED3;</h3>
<p>RabbitMQ &#x5728;&#x4F4E;&#x7248;&#x672C;&#x4E2D;&#xFF0C;rabbitmq manager &#x7BA1;&#x7406;&#x63D2;&#x4EF6;&#x5F00;&#x542F;&#x540E;&#xFF0C;&#x6574;&#x4E2A;&#x96C6;&#x7FA4;&#x7684;&#x6027;&#x80FD;&#x548C; &#x7BA1;&#x7406;&#x63D2;&#x4EF6;&#x91CC;&#x7684;rabbit_mgmt_db &#x8FDB;&#x7A0B;&#x6709;&#x76F8;&#x5173;&#x5927;&#x5173;&#x7CFB;&#x3002;</p>
<p>&#x5E76;&#x4E0D;&#x662F;&#x8282;&#x70B9;&#x8D8A;&#x591A;&#xFF0C;&#x6027;&#x80FD;&#x8D8A;&#x5F3A;&#xFF0C;&#x4E5F;&#x53D7;&#x8FD9;&#x4E2A;&#x7BA1;&#x7406;&#x8FDB;&#x7A0B;&#x5F71;&#x54CD;&#x3002;</p>
<p>&#x540C;&#x65F6;&#x5982;&#x679C;&#x77ED;&#x8FDE;&#x63A5;&#x975E;&#x5E38;&#x591A;&#xFF0C;&#x7BA1;&#x7406;&#x8282;&#x70B9;&#x538B;&#x529B;&#x4E5F;&#x4F1A;&#x53D8;&#x5927;&#x3002;&#x53EF;&#x80FD;&#x4F1A;&#x5F71;&#x54CD;&#x81EA;&#x5DF1;&#x7684;&#x76D1;&#x63A7;&#x8FDB;&#x7A0B;&#x53BB;&#x6293;&#x53BB;HTTP API&#x7684;&#x6570;&#x636E;&#xFF0C;&#x751A;&#x81F3;&#x9020;&#x6210;&#x7BA1;&#x7406;&#x8282;&#x70B9;&#x5185;&#x5B58;&#x7206;&#x6DA8;&#x95EE;&#x9898;&#x3002;</p>
<p>&#x9700;&#x8981;&#x5BF9;  statistics_db_event_queue  &#x505A;&#x597D;&#x76D1;&#x63A7;&#x64CD;&#x4F5C;&#x3002;</p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../实现原理/限流机制.html" class="navigation navigation-prev " aria-label="Previous page: 限流机制"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../实现原理/脑裂丢数调研.html" class="navigation navigation-next " aria-label="Next page: 脑裂丢数调研"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="../gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"highlight":{},"search":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
